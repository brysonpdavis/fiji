---
import "/src/styles/global.css";
import styles from "./[id].module.css";
import Pills from "../../components/Pills.astro";
import ReactEntrypoint from "../../components/ReactEntrypoint.astro";
import InviteMetadata from "../../components/InviteMetadata.astro";

export const prerender = false;

const id = Astro.params.id;

if (!id) {
  Astro.response.status = 404;
  Astro.response.statusText = "Not found";
  return;
}

const inviteApiUrl = `https://discord.com/api/v9/invites/${id}?with_counts=true&with_expiration=true&with_permissions=true`;

const response = await fetch(inviteApiUrl);
if (!response.ok) {
  Astro.response.status = response.status;
  Astro.response.statusText = response.statusText;
  return;
}

const invite = await response.json();

// Format member count with commas
const memberCount =
  invite.approximate_member_count?.toLocaleString() ||
  invite.profile?.member_count?.toLocaleString() ||
  "0";

const approxPresenceCount =
  invite.approximate_presence_count?.toLocaleString() ||
  invite.profile?.presence_count?.toLocaleString() ||
  "0";

// Construct description with member count
const description =
  invite.guild.description || invite.profile?.description || "";
const descriptionWithCount = `${description} | ${memberCount} members`;

const splashImageUrl = invite.guild.splash
  ? `https://cdn.discordapp.com/splashes/${invite.guild.id}/${invite.guild.splash}.webp?size=4096`
  : null;

const iconImageUrl = invite.guild.icon
  ? `https://cdn.discordapp.com/icons/${invite.guild.id}/${invite.guild.icon}.webp?size=512`
  : null;

---

<html lang="en">
  <head>
    <InviteMetadata invite={invite} />
    <script>
      function showSplashImage(img: HTMLImageElement) {
        img.style.opacity = "1";
      }

      const splashImage = document.getElementById(
        "splash-image",
      ) as HTMLImageElement | null;
      if (splashImage) {
        if (splashImage.complete) {
          showSplashImage(splashImage);
        } else {
          splashImage.addEventListener("load", () => {
            showSplashImage(splashImage);
          });
        }
      }
    </script>
    <script>
      import { onCLS, onINP, onLCP, onFCP } from "web-vitals";

      onCLS(console.log);
      onINP(console.log);
      onLCP(console.log);
      onFCP(console.log);
    </script>
  </head>
  <body>
    <div class={styles.background}>
      <img
        id="splash-image"
        class={styles.splashImage}
        src={splashImageUrl}
        alt={invite.guild.name}
      />
      <div class={styles.leftSplit}>
        <div class={styles.wrapper}>
          <section class={styles.authBox}>
            <div class="flex flex-col items-center gap-2 w-full">
              <img
                src={iconImageUrl}
                fetchpriority="high"
                class={styles.iconImage}
               />
              <div>You've been invited to join</div>
              <h1 class="font-sans text-xl font-extrabold">
                {invite.guild.name}
              </h1>
              <Pills online={approxPresenceCount} total={memberCount} />
              <ReactEntrypoint />
            </div>
          </section>
        </div>
      </div>
    </div>
  </body>
</html>
